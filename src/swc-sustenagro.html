<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/app-route/app-location.html">
<link rel="import" href="../bower_components/app-route/app-route.html">
<link rel="import" href="../bower_components/app-layout/app-header-layout/app-header-layout.html">
<link rel="import" href="../bower_components/app-layout/app-header/app-header.html">
<link rel="import" href="../bower_components/app-layout/app-toolbar/app-toolbar.html">
<link rel="import" href="../bower_components/iron-component-page/iron-component-page.html">
<link rel="import" href="../bower_components/iron-pages/iron-pages.html">
<link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../bower_components/iron-meta/iron-meta.html">
<link rel="import" href="../bower_components/paper-toolbar/paper-toolbar.html">
<link rel="import" href="../bower_components/paper-menu-button/paper-menu-button.html">
<link rel="import" href="../bower_components/paper-tabs/paper-tabs.html">
<link rel="import" href="../bower_components/paper-tabs/paper-tab.html">
<link rel="import" href="../bower_components/paper-menu/paper-menu.html">
<link rel="import" href="../bower_components/paper-item/paper-item.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../bower_components/paper-radio-button/paper-radio-button.html">
<link rel="import" href="../bower_components/paper-radio-group/paper-radio-group.html">
<link rel="import" href="../bower_components/neon-animation/neon-animated-pages.html">
<link rel="import" href="../bower_components/neon-animation/neon-animatable.html">
<link rel="import" href="../bower_components/neon-animation/animations/slide-from-left-animation.html">
<link rel="import" href="../bower_components/neon-animation/animations/slide-right-animation.html">

<link rel="import" href="./swc-dsl-editor.html">
<link rel="import" href="./swc-dsl-render.html">
<link rel="import" href="./swc-tabs-pages.html">
<link rel="import" href="./swc-feature.html">
<link rel="import" href="./swc-sustainability-matrix.html">
<link rel="import" href="./swc-sustainability-semaphore.html">

<dom-module id="swc-sustenagro">
    <template>
        <style>
            app-toolbar {
                background-color: rgba(255, 255, 255, 0.95);
                box-shadow: 0px 5px 6px -3px rgba(0, 0, 0, 0.4);
            }

            section {
                padding: 16px 40px;
            }

            .container {
                margin: 0 auto;
            }

            .paper {
                padding: 10px 12px;
                background-color: white;
                box-shadow: 0px 5px 6px -3px rgba(0, 0, 0, 0.4);
            }

            @media (max-width: 600px) {
                section {
                    padding: 0;
                }
            }
        </style>

        <app-location route="{{route}}"></app-location>

        <app-route
                route="{{route}}"
                pattern="/:page"
                data="{{data}}"
                tail="{{tail}}">
        </app-route>

        <app-header-layout>
            <app-header fixed>
                <app-toolbar>
                    <div main-title>SustenAgro</div>
                    <paper-button on-tap="changeViewInstance">
                        <iron-icon icon="add"></iron-icon>Instance
                    </paper-button>
                    <paper-button on-tap="changeViewInput">
                        <iron-icon icon="input"></iron-icon>Input
                    </paper-button>
                    <paper-button on-tap="changeViewReport">
                        <iron-icon icon="assessment"></iron-icon>Report
                    </paper-button>
                    <paper-button on-tap="changeViewAdmin">
                        <iron-icon icon="build"></iron-icon>Admin
                    </paper-button>
                    <paper-icon-button icon="menu"></paper-icon-button>
                </app-toolbar>
            </app-header>

            <iron-pages selected="{{data.page}}" attr-for-selected='id'>
                <section>
                    <div class="container paper ">

                    </div>
                </section>
                <section id="instance">
                    <div class="container paper">
                    </div>
                </section>
                <section id="input">
                    <form is="iron-form" id="form" method="post" action="/form/handler">
                        <div id="inputView" class="container">

                        </div>
                    </form>
                </section>
                <section id="report">
                    <div id="reportView" class="container paper">

                    </div>
                </section>
                <section id="admin" >
                    <div class="container">

                    </div>
                </section>
            </iron-pages>
        </app-header-layout>
  </template>

    <script>

        Polymer({
            is: 'swc-sustenagro',

            ready: function(){
                var DOM = this.$;
                var route = this.get('route');
                console.log(route);
                if(typeof RestClient != 'undefined'){

                    RestClient({path: 'http://localhost:8080/DataModel/datatypes.json'}).then(function (response) {
                        datatypes = response.entity[0];
                        RestClient({path: 'http://localhost:8080/DataModel'+route.path+'.json'}).then(function (response) {
                            renderHTML(response.entity);

                            switch (route.path){
                                case '/':
                                    break;

                                case '/input':
                                    DOM.inputView.innerHTML = html;
                                    break;

                                case '/report':
                                    DOM.reportView.innerHTML = html;
                                    break;

                            }
                        });
                    });
                }
            },

            changeViewInstance: function(event){
                var button = event.target;
                this.set('route.path', '/instance');
            },

            changeViewInput: function(event){
                var button = event.target;
                this.set('route.path', '/input');
            },

            changeViewReport: function(event){
                var button = event.target;
                var renderDiv = this.$.reportView;

                html = '';

                RestClient({path: 'http://localhost:8080/DataModel/report.json'}).then(function (response) {
                    renderHTML(response.entity);
                    renderDiv.innerHTML = html;
                });

                this.set('route.path', '/report');
            },

            changeViewAdmin: function(event){
                var button = event.target;
                this.set('route.path', '/admin');
            },
        });

        var html = '';
        var datatypes = [];

        function render(elements, parent){
            if(typeof elements != 'undefined' && elements.length > 0) {
                for (var idx in elements) {
                    var element = elements[idx];
                    var swc = createWebComponent(element, parent);

                    setTimeout(createSubTree.bind(null, element, swc), 0);
                }
            }
        }

        function createSubTree(element, swc) {
            var children = element.children;
            var current = element;
            var container = swc;

            if(typeof swc.getContainer === "function"){
                for(var idc in children){
                    current = children[idc];
                    container = swc.getContainer(idc)
                    render(current.children, container)
                }
            }
            else{
                render(current.children, container)
            }
        }

        function createWebComponent(element, parent){
            if(typeof element.widget == 'undefined'){
                return undefined;
            }
            else{
                switch (element.widget){
                    case 'swc-tabs-pages':
                        var tag = document.createElement(element.widget);
                        var tabsItems = [];

                        for(var idx in element.children){
                            tabsItems.push({"name": element.children[idx].label});
                        }
                        tag.setAttribute("tab-items", JSON.stringify(tabsItems));
                        parent.appendChild(tag);
                        return tag;
                        break;
                    default:
                        var tag = document.createElement(element.widget);

                        if(element.id)
                            tag.setAttribute('id', element.id);

                        if(element.name)
                            tag.setAttribute('name', element.name);

                        if(element.value)
                            tag.setAttribute('value', element.value);

                        if(element.label){
                            var content = document.createTextNode(element.label);
                            tag.appendChild(content)
                        }

                        if(element['aria-labelledby'])
                            tag.setAttribute('aria-labelledby', element['aria-labelledby']);

                        if(element.value)
                            tag.value = element.value;

                        if(element.type)
                            tag.setAttribute('type', element.type);

                        parent.appendChild(tag);
                        return tag;
                }
            }
        }

        function renderHTML(elements){
            if(typeof elements != 'undefined' && elements.length > 0) {
                var element;
                for (var idx in elements) {
                    element = elements[idx];

                    if(typeof element.type != 'undefined' && datatypes[element.type]){
                        element.widget = datatypes[element.type];
                        html += createStartTagHTML(element);
                    }

                    renderHTML(element.children);

                    if(typeof element.widget != 'undefined'){
                        html += createEndTagHTML(element);
                    }
                }
            }
        }

        function createStartTagHTML(element){
            switch(element.widget){
                case 'swc-tabs-pages':
                    var tabsItems = [];

                    for(var idx in element.children){
                        tabsItems.push({"name": element.children[idx].label, "id": element.children[idx].id});
                    }
                    return "<swc-tabs-pages tab-items='"+JSON.stringify(tabsItems)+"'>";
                    break;
                case 'div':
                    return "<div id='"+element.id+"'>";
                    break;
                case 'fieldset':
                    var tag = "<fieldset id='"+element.id+"'>";
                    tag += "<legend><h4>"+element.label+"</h4></legend>"
                    return tag;
                    break;
                case 'swc-feature':
                    var tag = "<swc-feature id='"+element.id+"' label='"+element.label+"'>";
                    return tag;
                    break;
                case 'swc-sustainability-matrix':
                    var tag = "<swc-sustainability-matrix ";
                    if(element.id)
                        tag += 'id="'+element.id+'" ';

                    if('x' in element)
                        tag += 'x="'+element.x+'" ';

                    if('y' in element)
                        tag += 'y="'+element.y+'" ';

                    if('label_x' in element)
                        tag += "label_x='"+JSON.stringify(element.label_x)+"' ";

                    if('label_y' in element)
                        tag += "label_y='"+JSON.stringify(element.label_y)+"' ";

                    if('range_x' in element)
                        tag += "range_x='"+JSON.stringify(element.range_x)+"' ";

                    if('range_y' in element)
                        tag += "range_y='"+JSON.stringify(element.range_y)+"' ";

                    if('quadrants' in element)
                        tag += "quadrants='"+JSON.stringify(element.quadrants)+"' ";

                    if('recomendations' in element)
                        tag += "recomendations='"+JSON.stringify(element.recomendations)+"' ";

                    tag += ">";

                    return tag;
                    break;

                case 'swc-sustainability-semaphore':
                    var tag = "<swc-sustainability-semaphore ";
                    if(element.id)
                        tag += 'id="'+element.id+'" ';

                    if(element.value)
                        tag += 'value="'+element.value+'" ';

                    if('label' in element)
                        tag += "label='"+JSON.stringify(element.label)+"' ";

                    if('legend' in element)
                        tag += "legend='"+JSON.stringify(element.legend)+"' ";

                    if('range' in element)
                        tag += "range='"+JSON.stringify(element.range)+"' ";

                    tag += ">";

                    return tag;
                    break;

                default:
                    var tag = '<'+element.widget+' ';

                    if('id' in element)
                        tag += 'id="'+element.id+'" ';

                    if('name' in element)
                        tag += 'name="'+element.name+'" ';

                    if('value' in element)
                        tag += 'value="'+element.value+'" ';

                    tag += '>';

                    if('label' in element){
                        tag += element.label;
                    }
                    return tag;
            }
        }

        function createEndTagHTML(element) {
            return '</' + element.widget + '>';
        }

        function getDataModel(name){

        }
    </script>
</dom-module>
